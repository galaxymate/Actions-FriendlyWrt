name: Build kmod-amneziawg (kernel 6.1)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses-dev libssl-dev python3 python3-dev \
          python3-pyelftools python3-setuptools rsync unzip zlib1g-dev \
          swig file wget

    - name: Init FriendlyWrt
      run: |
        cd project/friendlywrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configure NanoPi R76S (kernel 6.1)
      run: |
        cd project/friendlywrt
        make defconfig

        # Target
        ./scripts/config set CONFIG_TARGET_rockchip=y
        ./scripts/config set CONFIG_TARGET_rockchip_armv8=y
        ./scripts/config set CONFIG_TARGET_rockchip_armv8_DEVICE_friendlyarm_nanopi-r76s=y

        # Packages
        ./scripts/config set CONFIG_PACKAGE_kmod-amneziawg=m
        ./scripts/config set CONFIG_PACKAGE_amneziawg-tools=m

        make defconfig

    - name: Build toolchain (once)
      run: |
        cd project/friendlywrt
        make toolchain/install -j$(nproc)

    - name: Prepare kernel (6.1)
      run: |
        cd project/friendlywrt
        make target/linux/prepare
        make target/linux/compile

    - name: Build amneziawg modules
      run: |
        cd project/friendlywrt
        make package/kmod-amneziawg/compile V=s
        make package/amneziawg-tools/compile V=s

    - name: Upload IPK artifacts
      uses: actions/upload-artifact@v4
      with:
        name: amneziawg-ipk
        path: project/friendlywrt/bin/packages/
