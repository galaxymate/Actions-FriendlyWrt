name: Build AmneziaWG kmod for NanoPi R76S

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt update
        sudo apt install -y git build-essential gawk gettext unzip file libssl-dev \
        python3-pyelftools python3-setuptools swig flex bison

    - name: Install repo tool
      run: |
        git clone https://github.com/friendlyarm/repo.git /tmp/repo
        sudo install -m 755 /tmp/repo/repo /usr/local/bin/repo    

    - name: Clone FriendlyWrt 24.10 (rk3576)
      run: |
        mkdir project
        cd project
        repo init --depth=1 \
          -u github.com \
          -b master-v24.10 \
          -m rk3576.xml \
          --repo-url=github.com \
          --no-clone-bundle
        repo sync -c
        # FriendlyWrt specific: link the actual openwrt directory
        ln -sf $(pwd)/friendlywrt $(pwd)/openwrt

    - name: Add AmneziaWG tools feed
      run: |
        cd project/friendlywrt
        # Add the feed and specifically name it 'amnezia'
        echo "src-git amnezia >> feeds.conf.default
        ./scripts/feeds update amnezia
        ./scripts/feeds install -a -p amnezia

    - name: Configure build
      run: |
        cd project/friendlywrt
        # Create a minimal config for the RK3576 target
        cat > .config <<EOF
        CONFIG_TARGET_rockchip=y
        CONFIG_TARGET_rockchip_armv8=y
        CONFIG_TARGET_rockchip_armv8_DEVICE_friendlyarm_nanopi-r76s=y
        CONFIG_PACKAGE_kmod-amneziawg=m
        CONFIG_PACKAGE_amneziawg-tools=m
        CONFIG_PACKAGE_luci-proto-amneziawg=m
        EOF
        make defconfig

    - name: Build AmneziaWG packages
      run: |
        cd project/friendlywrt
        # Use the FULL feed path to avoid "No rule to make target"
        make package/feeds/amnezia/kmod-amneziawg/compile -j$(nproc) V=s
        make package/feeds/amnezia/amneziawg-tools/compile -j$(nproc) V=s

    - name: Upload IPK packages
      uses: actions/upload-artifact@v4
      with:
        name: amneziawg-r76s-ipks
        path: project/friendlywrt/bin/packages/aarch64_generic/amnezia/*.ipk
